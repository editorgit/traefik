version: '3.8'

services:
  traefik:
    image: traefik:v3.6.2
    restart: unless-stopped

    command:
      # Global
      - "--global.checkNewVersion=true"
      - "--global.sendAnonymousUsage=false"

      # Entrypoints
      - "--entrypoints.http.address=:80"
      - "--entrypoints.http.http.redirections.entrypoint.to=https"
      - "--entrypoints.http.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.http.http.redirections.entrypoint.permanent=true"
      - "--entrypoints.https.address=:443"
      - "--entrypoints.https.http.tls.certResolver=letsencrypt"
      - "--entrypoints.https.http2.maxConcurrentStreams=250"
      - "--entrypoints.https.http3"
      - "--entrypoints.metrics.address=:8082"

      # Certificate Resolvers
      - "--certificatesresolvers.letsencrypt.acme.email=siplace@gmail.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/acme/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=http"

      # Swarm Provider (v3 uses separate provider for Swarm)
      - "--providers.swarm.endpoint=unix:///var/run/docker.sock"
      - "--providers.swarm.exposedByDefault=false"
      - "--providers.swarm.network=proxy"
      - "--providers.swarm.watch=true"

      # Logging
      - "--log.level=INFO"
      - "--log.format=json"
      - "--log.filePath=/var/log/traefik/traefik.log"
      - "--accesslog.format=json"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--accesslog.filters.statuscodes=200,300-302,400-599"
      - "--accesslog.fields.headers.names.User-Agent=keep"
      - "--accesslog.fields.headers.names.X-Forwarded-For=keep"

      # Metrics
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.entrypoint=metrics"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addRoutersLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"

#    ports:
#      - "80:80"       # HTTP
#      - "443:443"     # HTTPS
#      - "443:443/udp" # HTTP/3 (QUIC)
    ports:
      - target: 80
        published: 80
        mode: host
      - target: 443
        published: 443
        mode: host
      - target: 443
        published: 443
        protocol: udp
        mode: host

    networks:
      - proxy

    volumes:
      # Docker socket для service discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Let's Encrypt хранилище
      - traefik-acme:/acme

      # Логи
      - traefik-logs:/var/log/traefik

    environment:
      - TZ=Europe/Helsinki

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

      update_config:
        parallelism: 1
        delay: 10s
        order: stop-first

      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

volumes:
  traefik-acme:
  traefik-logs:

networks:
  proxy:
    external: true
